<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undertale ç©å®¶ä»‹ç´¹ (å‹•æ…‹ç”Ÿæˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Tone.js (ç”¨æ–¼åˆæˆéŸ³æ¨‚) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366f1; /* Indigo color */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Undertale é¢¨æ ¼å¿ƒè·³å‹•ç•« */
        .heart-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        /* HP è¡€æ¢æ¨£å¼ */
        .hp-bar-fill {
            height: 100%;
            background-color: #ff0000; /* ç´…è‰² */
            transition: width 0.5s ease-out;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <!-- ä¸»å…§å®¹å¡ç‰‡ -->
    <div class="max-w-4xl w-full bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-t-8 border-indigo-600">
        
        <!-- ğŸ¶ éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex justify-center mb-6">
            <button id="music-btn" onclick="toggleMegalovania()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition duration-150 ease-in-out">
                ğŸ¶ æ’­æ”¾ MEGALOVANIA
            </button>
        </div>
        
        <!-- äº’å‹•å€å¡Šï¼šHP & è§’è‰²å°è©± -->
        <div class="mb-8 p-4 bg-gray-100 rounded-lg border border-gray-200 cursor-pointer hover:shadow-inner transition duration-200" onclick="showSansDialogue()">
            <div class="flex items-center justify-between sm:text-xl font-mono text-gray-800">
                <div class="flex items-center space-x-2">
                    <!-- å¿ƒå½¢åœ–æ¨™ -->
                    <span class="text-red-600 text-3xl heart-pulse">â¤ï¸</span>
                    <!-- HP è³‡è¨Š -->
                    <span id="player-status">LV 1 | HP 20 / 20</span>
                </div>
                
                <!-- é»æ“Šæç¤º -->
                <span class="text-sm text-indigo-500 font-semibold hidden sm:inline-block">é»æ“ŠæŸ¥çœ‹ Sans çš„å»ºè­°...</span>
            </div>

            <!-- HP è¡€æ¢ -->
            <div class="mt-2 h-3 bg-gray-300 rounded-full overflow-hidden">
                <div id="hp-bar" class="hp-bar-fill" style="width: 100%;"></div>
            </div>

            <!-- å°è©±æ°£æ³¡ -->
            <p id="dialogue-box" class="mt-4 p-3 bg-white border border-gray-400 rounded-lg text-center font-bold text-gray-700 hidden transition duration-300 transform scale-95 origin-top">
                hey kiddo. you look like you're having a good time.
            </p>
        </div>


        <!-- åœ–ç‰‡å±•ç¤ºå€ -->
        <div class="my-8 flex justify-center">
            <!-- åœ–ç‰‡å°‡åœ¨æ­¤å‹•æ…‹è¼‰å…¥ -->
            <div id="dynamic-image-container" class="max-h-96 w-full sm:w-auto flex flex-col items-center justify-center min-h-[350px] rounded-lg shadow-xl border-4 border-gray-100 bg-gray-50 transition duration-300">
                <div class="loading-spinner"></div>
                <p class="mt-4 text-gray-500 text-sm">æ­£åœ¨ç”Ÿæˆ Sans çš„åƒç´ åœ–...</p>
            </div>
        </div>
        
        <!-- é‡æ–°ç”ŸæˆæŒ‰éˆ• -->
        <div class="flex justify-center mb-8">
            <button id="retry-btn" onclick="generateImage()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                é‡æ–°ç”Ÿæˆåœ–åƒ
            </button>
        </div>

        <!-- å¤§æ¨™é¡Œ (å¼·åˆ¶æ›è¡Œæˆå…©è¡Œ) -->
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-6 text-center leading-tight">
            huh. always wondered why people never use<br>their strongest attack first.
        </h1>
        
        <!-- åˆ†éš”ç·š -->
        <hr class="my-10 border-t-2 border-indigo-200">

        <!-- å°æ¨™é¡Œèˆ‡è‡ªæˆ‘ä»‹ç´¹ -->
        <div class="text-center">
            <h2 class="text-3xl font-bold text-indigo-600 mb-4">
                â­ è‡ªæˆ‘ä»‹ç´¹ï¼šä¸€å€‹ç†±æ„›åœ°ä¸‹ä¸–ç•Œçš„éˆé­‚ â­
            </h2>
        </div>

        <div class="text-lg text-gray-700 leading-relaxed space-y-4">
            <!-- è‡ªæˆ‘ä»‹ç´¹æ­£æ–‡ -->
            <p>
                å¤§å®¶å¥½ï¼æˆ‘æ˜¯é€™å€‹ ID èƒŒå¾Œï¼Œä¸€å€‹å° **Undertale** ç˜‹ç‹‚è‘—è¿·çš„ç©å®¶ã€‚å°æˆ‘ä¾†èªªï¼Œé€™æ¬¾éŠæˆ²æ—©å·²è¶…è¶Šäº†ã€ŒéŠæˆ²ã€çš„ç¯„ç–‡ï¼Œå®ƒæ˜¯ä¸€éƒ¨å……æ»¿å“²å­¸æ€è¾¨å’Œæº«æš–æƒ…æ„Ÿçš„è—è¡“å“ã€‚æˆ‘ç¬¬ä¸€æ¬¡è¸å…¥åœ°ä¸‹ä¸–ç•Œæ™‚ï¼Œå°±è¢« Toby Fox ç²¾å¿ƒç·¨ç¹”çš„æ•…äº‹å’Œç¨ç‰¹çš„æˆ°é¬¥ç³»çµ±æ·±æ·±å¸å¼•ã€‚å®ƒæ‰“ç ´äº†å‚³çµ± RPG çš„ã€Œæ®ºæ€ªå‡ç´šã€é‚è¼¯ï¼Œè®“æˆ‘æ„è­˜åˆ°æ¯ä¸€æ¬¡é¸æ“‡â€”â€”ç„¡è«–æ˜¯**ä»æ…ˆ**é‚„æ˜¯**æˆ°é¬¥**â€”â€”éƒ½æœƒå°æ•´å€‹ä¸–ç•Œç”¢ç”ŸçœŸå¯¦è€Œæ²‰é‡çš„å½±éŸ¿ã€‚é€™ç¨®**é¸æ“‡çš„é‡é‡**æ˜¯å…¶ä»–éŠæˆ²é›£ä»¥æ¯”æ“¬çš„ã€‚
            </p>
            <p>
                æˆ‘æœ€å–œæ­¡çš„è§’è‰²é **Sans** è«å±¬ã€‚ä»–é‚£ç¨®çœ‹ä¼¼æ‡¶æ•£å»åˆæ·±è—ä¸éœ²çš„ç¥ç§˜æ„Ÿå’Œå†·å¹½é»˜ç¸½èƒ½è®“æˆ‘åˆæ„›åˆæ€•ï¼Œè€Œä»–åœ¨ã€Œå¯©åˆ¤ã€ä¸­çš„ç¨ç™½æ›´æ˜¯éœ‡æ’¼äººå¿ƒã€‚ç•¶ç„¶ï¼Œé‚„æœ‰ç¸½æ˜¯å……æ»¿å¸Œæœ›çš„ **Papyrus** å’Œçµ¦äºˆç©å®¶æœ€åˆæº«æš–çš„ **Toriel**ï¼Œä»–å€‘å…±åŒæ§‹æˆäº†é€™å€‹ä¸–ç•Œçš„éˆé­‚ï¼Œè®“äººç„¡æ³•ä¸æ„›ã€‚æˆ‘ç†±è¡·æ–¼æ¢ç´¢éŠæˆ²çš„å¤šé‡çµå±€ï¼Œå°¤å…¶æ˜¯**å’Œå¹³ç·š**å¸¶ä¾†çš„æ„Ÿå‹•èˆ‡æ²»ç™’ï¼Œè®“æˆ‘ä¹…ä¹…ä¸èƒ½å¿˜æ‡·ã€‚Undertale ä¸åªæ˜¯ä¸€æ¬¾éŠæˆ²ï¼Œå®ƒæé†’äº†æˆ‘ï¼Œå³ä½¿é¢å°çµ•æœ›ï¼Œæˆ‘å€‘ä¹Ÿæ°¸é æœ‰é¸æ“‡å–„è‰¯çš„æ¬Šåˆ©ï¼Œä¸¦ç›¸ä¿¡æ¯ä¸€å€‹éˆé­‚éƒ½èƒ½å¸¶ä¾†æ”¹è®Šã€‚æœŸå¾…åœ¨é€™è£¡é‡åˆ°æ›´å¤šåŒæ¨£è¢«é€™æ¬¾éŠæˆ²æ„Ÿå‹•çš„æœ‹å‹ï¼Œä¸€èµ·åˆ†äº«é‚£äº›å‹•äººçš„ç¬é–“å’Œéš±è—çš„ç§˜å¯†ï¼
            </p>
            <!-- éŒ¯èª¤è¨Šæ¯æç¤ºå€ -->
            <p id="error-message" class="text-red-500 mt-4 text-center font-bold hidden"></p>
        </div>

    </div>

    <script type="module">
        const imageContainer = document.getElementById('dynamic-image-container');
        const errorMessage = document.getElementById('error-message');
        const retryBtn = document.getElementById('retry-btn'); 
        const dialogueBox = document.getElementById('dialogue-box');
        const hpBar = document.getElementById('hp-bar');
        const playerStatus = document.getElementById('player-status');
        const musicBtn = document.getElementById('music-btn'); // éŸ³æ¨‚æŒ‰éˆ•

        // Tone.js è®Šæ•¸
        let synth;
        let part;
        let isPlaying = false;
        
        // å‚™ç”¨éœæ…‹åœ–ç‰‡ (å…¨é»ƒé•·è™Ÿåƒç´ åœ–é¢¨æ ¼çš„ä½”ä½ç¬¦)
        const FALLBACK_IMAGE_URL = "https://placehold.co/400x350/000000/F0F0F0?text=Sans+Pixel+Art+Failure+Backup";
        
        // Sans çš„ç¶“å…¸æˆ–æœ‰è¶£çš„å°è©
        const SANS_DIALOGUES = [
            "heya. you've been busy, huh?",
            "geeeet dunked on!",
            "wanna have a bad time? 'cause if you take another step, you are REALLY not going to like what happens next.",
            "what a beautiful day outside. birds are singing, flowers are blooming... on days like these, kids like you... should be burning in hell.",
            "it's a beautiful day.",
            "you're gonna have to try a little harder than THAT.",
            "i'm busy. i'm working myself down to the BONE.",
        ];

        // æç¤ºè© (Prompt) æè¿°
        const userPrompt = "A colored, 8-bit style pixel art image of the character Sans from the game Undertale. Sans is a skeleton wearing a blue hoodie. He is depicted playing a solid yellow trombone. The style must strictly adhere to the original Undertale pixel art aesthetic. The image should have a pure white background.";
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        /**
         * è¨­ç½® Megalovania çš„ Tone.js é‚è¼¯
         */
        function setupMegalovania() {
            // è¨­ç½®ä¸€å€‹ç°¡å–®çš„åˆæˆå™¨ (Synth)ï¼Œæ¨¡ä»¿ 8-bit/FM è²éŸ³
            synth = new Tone.Synth({
                oscillator: { type: "square" }, // æ–¹æ³¢ (Square) è²éŸ³é©åˆ 8-bit
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.5 },
            }).toDestination();
            
            // Megalovania ä¸»æ—‹å¾‹ (ç°¡åŒ–ç‰ˆï¼Œç”¨ Tone.js æ ¼å¼è¡¨ç¤º)
            const MEG_NOTES = [
                // (å°ç¯€:æ‹:16åˆ†éŸ³ç¬¦, éŸ³é«˜)
                ["0:0:0", "D4"], ["0:0:1", "D4"], ["0:0:2", "D5"], ["0:0:3", "A4"],
                ["0:1:0", "A4"], ["0:1:1", "G4"], ["0:1:2", "F#4"], ["0:1:3", "F4"],
                ["0:2:0", "D4"], ["0:2:1", "F4"], ["0:2:2", "G4"], 
                
                ["0:3:0", "C4"], ["0:3:1", "C4"], ["0:3:2", "D5"], ["0:3:3", "A4"],
                ["0:4:0", "A4"], ["0:4:1", "G4"], ["0:4:2", "F#4"], ["0:4:3", "F4"],
                ["0:5:0", "D4"], ["0:5:1", "F4"], ["0:5:2", "G4"]
            ];

            // å‰µå»ºä¸€å€‹å¾ªç’°æ’­æ”¾çš„ Part
            part = new Tone.Part((time, note) => {
                synth.triggerAttackRelease(note, "8n", time); // æ’­æ”¾å…«åˆ†éŸ³ç¬¦
            }, MEG_NOTES).start(0);

            part.loop = true;
            part.loopEnd = '6m'; // å¾ªç’°çµæŸæ™‚é–“ (6 å€‹å°ç¯€)
            Tone.Transport.bpm.value = 180; // å¿«é€Ÿ BPM
        }
        
        /**
         * æ’­æ”¾/æš«åœ Megalovania
         */
        window.toggleMegalovania = async function() {
            if (!synth) {
                // ç¬¬ä¸€æ¬¡é»æ“Šï¼Œåˆå§‹åŒ–éŸ³é »ç’°å¢ƒ
                await Tone.start();
                setupMegalovania();
            }

            if (isPlaying) {
                // åœæ­¢éŸ³æ¨‚
                Tone.Transport.stop();
                musicBtn.textContent = 'ğŸ¶ æ’­æ”¾ MEGALOVANIA';
                musicBtn.classList.remove('animate-pulse');
                isPlaying = false;
            } else {
                // æ’­æ”¾éŸ³æ¨‚
                Tone.Transport.start();
                musicBtn.textContent = 'â¸ï¸ æš«åœ MEGALOVANIA';
                musicBtn.classList.add('animate-pulse'); // æ’­æ”¾æ™‚æ·»åŠ é–ƒçˆæ•ˆæœ
                isPlaying = true;
            }
        }


        /**
         * é¡¯ç¤º Sans çš„éš¨æ©Ÿå°è©
         */
        window.showSansDialogue = function() {
            
            // æ›´æ–° HP è³‡è¨Š (æ¨¡æ“¬)
            const displayHP = Math.max(1, Math.floor(Math.random() * 20) + 1); // éš¨æ©Ÿé¡¯ç¤º 1-20
            const displayLV = Math.floor(Math.random() * 10) + 1; // éš¨æ©Ÿé¡¯ç¤º 1-10

            playerStatus.textContent = `LV ${displayLV} | HP ${displayHP} / 20`;
            hpBar.style.width = `${(displayHP / 20) * 100}%`;

            // éš¨æ©Ÿé¸æ“‡å°è©
            const randomIndex = Math.floor(Math.random() * SANS_DIALOGUES.length);
            const dialogue = SANS_DIALOGUES[randomIndex];

            // é¡¯ç¤ºå°è©±æ¡†
            dialogueBox.textContent = dialogue;
            dialogueBox.classList.remove('hidden', 'scale-95');
            dialogueBox.classList.add('scale-100');

            // 5 ç§’å¾Œéš±è—å°è©±æ¡†
            setTimeout(() => {
                dialogueBox.classList.add('scale-95');
                setTimeout(() => dialogueBox.classList.add('hidden'), 300);
            }, 5000);
        }
        
        /**
         * ä»¥æŒ‡æ•¸é€€é¿æ©Ÿåˆ¶é‡è©¦ API è«‹æ±‚
         */
        async function fetchWithRetry(fetcher, retries = 3, delay = 1000) {
            try {
                return await fetcher();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(fetcher, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        function displayImage(imageUrl) {
            imageContainer.innerHTML = `
                <img 
                    src="${imageUrl}" 
                    alt="AI ç”Ÿæˆçš„ Sans åƒç´ è—è¡“" 
                    class="max-h-96 w-auto rounded-lg shadow-xl object-contain p-4 transition duration-300 hover:shadow-indigo-300"
                />
            `;
            // ç§»é™¤èƒŒæ™¯å’Œæœ€å°é«˜åº¦é™åˆ¶ï¼Œè®“åœ–ç‰‡æ±ºå®šå®¹å™¨å¤§å°
            imageContainer.classList.remove('bg-gray-50', 'min-h-[350px]', 'flex-col');
        }

        function displayError(message, useFallback = false) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            retryBtn.disabled = false;
            retryBtn.textContent = 'é‡æ–°ç”Ÿæˆåœ–åƒ';

            if (useFallback) {
                 // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œé¡¯ç¤ºå‚™ç”¨åœ–ç‰‡
                 displayImage(FALLBACK_IMAGE_URL);
                 // èª¿æ•´éŒ¯èª¤è¨Šæ¯
                 errorMessage.textContent = 'åœ–åƒè‡ªå‹•ç”Ÿæˆå¤±æ•—ï¼Œå·²åˆ‡æ›è‡³å‚™ç”¨åœ–ç‰‡ã€‚æ‚¨å¯ä»¥é»æ“ŠæŒ‰éˆ•æ‰‹å‹•é‡è©¦ã€‚';
            } else {
                 imageContainer.innerHTML = `<p class="text-red-500">ç”Ÿæˆå¤±æ•—</p>`;
            }
        }

        async function generateImage() {
            // 1. é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            imageContainer.innerHTML = `<div class="loading-spinner"></div><p class="mt-4 text-gray-500 text-sm">æ­£åœ¨ç”Ÿæˆ Sans çš„åƒç´ åœ–...</p>`;
            imageContainer.classList.add('bg-gray-50', 'min-h-[350px]', 'flex-col');
            errorMessage.classList.add('hidden');
            retryBtn.disabled = true; 
            retryBtn.textContent = 'ç”Ÿæˆä¸­...'; 

            const payload = { 
                instances: [{ prompt: userPrompt }], 
                parameters: { "sampleCount": 1 } 
            };

            const fetcher = () => fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            try {
                // 2. åŸ·è¡Œ API è«‹æ±‚
                const response = await fetchWithRetry(fetcher);
                const result = await response.json();

                // 3. è™•ç†éŸ¿æ‡‰
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    displayImage(imageUrl);
                } else {
                    throw new Error("API è¿”å›çš„æ•¸æ“šçµæ§‹éŒ¯èª¤æˆ–æ²’æœ‰åœ–ç‰‡æ•¸æ“šã€‚");
                }
            } catch (error) {
                console.error('åœ–åƒç”Ÿæˆå¤±æ•—:', error);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œåˆ‡æ›åˆ°å‚™ç”¨åœ–ç‰‡ (æ–¹æ¡ˆä¸€)
                displayError('åœ–åƒç”Ÿæˆå¤±æ•—', true); 
            } finally {
                // 5. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                retryBtn.disabled = false;
                retryBtn.textContent = 'é‡æ–°ç”Ÿæˆåœ–åƒ';
            }
        }

        // é¦–æ¬¡è¼‰å…¥æ™‚è‡ªå‹•ç”Ÿæˆåœ–ç‰‡
        window.onload = generateImage;
    </script>
</body>
</html>
